<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SMART Statin CDS - Debug</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 16px; }
    pre  { border: 1px solid #ccc; padding: 8px; max-height: 35vh; overflow: auto; }
    h2   { margin-top: 24px; }
  </style>
</head>
<body>
  <h1>SMART Statin CDS (Debug)</h1>

  <h2>Decision</h2>
  <pre id="decision">Computing statin recommendation...</pre>

  <h2>Patient</h2>
  <pre id="patient">Loading patient...</pre>

  <h2>Observations</h2>
  <pre id="obs">Loading observations...</pre>

  <script type="text/javascript">
    const patientId = "671555"; // 你的測試病人 id

    // 從 Observation Bundle 中抓出第一筆 LDL-C 數值（mg/dL）
    function extractLdlValue(obsBundle) {
      if (!obsBundle) return null;

      // 有些情況伺服器會回傳 [bundle] 陣列，先攤平成單一 Bundle
      const bundle = Array.isArray(obsBundle) ? obsBundle[0] : obsBundle;
      if (!bundle.entry || !bundle.entry.length) return null;

      for (const e of bundle.entry) {
        const res = e.resource;
        if (!res || res.resourceType !== "Observation") continue;

        // 之後可以再加上 code 過濾（LOINC LDL-C），目前先拿第一筆有 valueQuantity 的
        if (res.valueQuantity && typeof res.valueQuantity.value === "number") {
          return res.valueQuantity.value;
        }
      }
      return null;
    }

    // 非常簡化版 Statin 建議（只看 LDL-C）
    function evaluateStatinRecommendation(ldlValue) {
      if (ldlValue === null) {
        return "找不到 LDL-C 檢驗值，無法給出建議。";
      }

      // 示意邏輯：假設一般風險成年人，LDL-C ≥ 130 mg/dL 建議啟動 Statin。 [web:87]
      if (ldlValue >= 130) {
        return (
          "LDL-C = " + ldlValue + " mg/dL\n" +
          "建議：啟動中等強度 Statin，並合併生活型態調整。\n" +
          "說明：示意邏輯（未區分完整風險分層），以 LDL-C ≥ 130 mg/dL 作為起始治療門檻。"
        );
      } else {
        return (
          "LDL-C = " + ldlValue + " mg/dL\n" +
          "建議：暫以生活型態調整與追蹤為主，尚無強制啟動 Statin 的需求（示意邏輯）。"
        );
      }
    }

    FHIR.oauth2.ready().then(function (client) {
      // 讀 Patient
      client.request("Patient/" + patientId).then(
        function (pt) {
          document.getElementById("patient").innerText =
            JSON.stringify(pt, null, 2);
        },
        function (error) {
          document.getElementById("patient").innerText =
            error.stack || String(error);
        }
      );

      // 讀 Observation，並同時用來算決策
      client.request("Observation?patient=" + patientId, {
        pageLimit: 0
      }).then(
        function (bundle) {
          document.getElementById("obs").innerText =
            JSON.stringify(bundle, null, 2);

          const ldl = extractLdlValue(bundle);
          const decision = evaluateStatinRecommendation(ldl);
          document.getElementById("decision").innerText = decision;
        },
        function (error) {
          document.getElementById("obs").innerText =
            error.stack || String(error);
          document.getElementById("decision").innerText =
            "讀取 Observation 失敗，無法計算建議。\n" +
            (error.stack || String(error));
        }
      );
    }).catch(function (err) {
      const msg = "SMART init error:\n" + (err.stack || String(err));
      document.getElementById("patient").innerText = msg;
      document.getElementById("obs").innerText = msg;
      document.getElementById("decision").innerText = msg;
    });
  </script>
</body>
</html>
