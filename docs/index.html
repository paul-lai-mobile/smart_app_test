<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SMART Statin CDS - Debug View</title>
  <!-- 一樣載入 SMART on FHIR JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 16px; }
    pre  { border: 1px solid #ccc; padding: 8px; max-height: 40vh; overflow: auto; }
    h2   { margin-top: 24px; }
  </style>
</head>
<body>
  <h1>SMART Statin CDS (Debug)</h1>

  <h2>Patient</h2>
  <pre id="patient">Loading patient...</pre>

  <h2>Observations</h2>
  <pre id="obs">Loading observations...</pre>

  <script type="text/javascript">
    // 等待 SMART OAuth 流程完成，取得 client
    FHIR.oauth2.ready().then(function (client) {
      // 1) 讀取目前脈絡中的病人
      client.patient.read().then(
        function (pt) {
          document.getElementById("patient").innerText =
            JSON.stringify(pt, null, 2);
        },
        function (error) {
          document.getElementById("patient").innerText = error.stack || String(error);
        }
      );

      // 2) 查詢這個病人的所有 Observation（先不過濾，之後再加 code 過濾 LDL-C）
      client.request("Observation?patient=" + client.patient.id, {
        pageLimit: 0        // 把所有分頁都抓回來（如果有的話）
      }).then(
        function (bundle) {
          document.getElementById("obs").innerText =
            JSON.stringify(bundle, null, 2);
        },
        function (error) {
          document.getElementById("obs").innerText = error.stack || String(error);
        }
      );
    }).catch(function (err) {
      document.getElementById("patient").innerText = "SMART init error:\n" + (err.stack || String(err));
      document.getElementById("obs").innerText     = "SMART init error:\n" + (err.stack || String(err));
    });
  </script>
</body>
</html>
