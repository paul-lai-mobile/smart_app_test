<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SMART Statin CDS - Debug</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 16px; }
    pre  { border: 1px solid #ccc; padding: 8px; max-height: 40vh; overflow: auto; }
    h2   { margin-top: 24px; }
  </style>
</head>
<body>
  <h1>SMART Statin CDS (Debug)</h1>

  <h2>Patient</h2>
  <pre id="patient">Loading patient...</pre>

  <h2>Observations</h2>
  <pre id="obs">Loading observations...</pre>

  <script type="text/javascript">
    // 先填入你剛剛在回應中看到建立的 Patient id（location: "Patient/671555/_history/1"）
    // 取中間那段 671555 當作 patientId
    const patientId = "671555";

    FHIR.oauth2.ready().then(function (client) {
      // 1) 不再用 client.patient.read()，改成直接用固定 id 讀 Patient
      client.request("Patient/" + patientId).then(
        function (pt) {
          document.getElementById("patient").innerText =
            JSON.stringify(pt, null, 2);
        },
        function (error) {
          document.getElementById("patient").innerText =
            error.stack || String(error);
        }
      );

      // 2) 用同一個 patientId 查 Observation
      client.request("Observation?patient=" + patientId, {
        pageLimit: 0
      }).then(
        function (bundle) {
          document.getElementById("obs").innerText =
            JSON.stringify(bundle, null, 2);
        },
        function (error) {
          document.getElementById("obs").innerText =
            error.stack || String(error);
        }
      );
    }).catch(function (err) {
      document.getElementById("patient").innerText =
        "SMART init error:\n" + (err.stack || String(err));
      document.getElementById("obs").innerText =
        "SMART init error:\n" + (err.stack || String(err));
    });
  </script>
</body>
</html>
